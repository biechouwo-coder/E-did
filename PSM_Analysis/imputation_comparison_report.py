# -*- coding: utf-8 -*-
"""
生成插值前后PSM分析对比报告
"""
import pandas as pd
import sys
import io

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

print("="*70)
print("PSM分析：插值前后对比报告")
print("="*70)

summary = """
======================================================================
PSM倾向得分匹配分析：插值前后对比报告
======================================================================

一、数据插值策略
-----------
使用多重插值策略处理缺失值：

1. 时间序列线性插值
   - 对每个城市的时间序列进行线性插值
   - 适用场景：单个城市有少量年份缺失

2. 同组别同年份均值填充
   - 用同treat组、同年份的均值填充
   - 适用场景：整个时间序列缺失的城市

3. 同组别全局均值填充
   - 用同treat组的全局均值填充
   - 适用场景：仍然缺失的观测

插值效果：
• 插值前总缺失: 2,691个观测
• 插值后总缺失: 0个观测
• 插值成功率: 100%

二、样本量对比
-----------

基期（2009年）样本量变化：
                    插值前    插值后    变化
总观测数:           203      285      +40.4%
处理组(treat=1):     98       127      +29.6%
对照组(treat=0):     105      158      +50.5%

三、匹配结果对比
-----------

                    插值前    插值后
处理组数量:         98       127
对照组数量:         105      158
成功匹配:           89对     122对
匹配率:             90.8%    96.1%
平均得分差:         0.0059   0.0051
最大得分差:         0.0467   0.0409

四、平衡性检验对比
-----------

匹配前标准化差异 (%):
变量                    插值前    插值后
─────────────────────────────────────
gdp_per_capita          57.70%    54.80%
pop_density             45.17%    40.61%
industrial_upgrading    30.53%    29.21%
ln_fdi                  56.41%    66.93%

匹配后标准化差异 (%):
变量                    插值前    插值前    改善方向
───────────────────────────────────────────
gdp_per_capita          25.66%    27.08%    变差 ▲
pop_density             24.48%    16.96%    改善 ✓
industrial_upgrading    -3.25%    31.29%    变差 ▲
ln_fdi                  31.39%    30.90%    改善 ✓

标准化差异 < 10% 的变量数:
插值前: 1/4 (industrial_upgrading)
插值后: 0/4 (均未达到<10%标准)

五、匹配质量评估
-----------

插值前:
• 匹配率: 90.8%
• 匹配质量: 一般（1/4变量平衡）
• 样本代表性: 有限（删除了29%的处理组观测）

插值后:
• 匹配率: 96.1% (+5.3个百分点)
• 匹配质量: 一般（0/4变量平衡）
• 样本代表性: 更好（保留了所有观测）

六、主要发现
-----------

1. 样本量大幅提升
   插值策略使2009年可用样本从203提升至285（+40.4%）
   特别是对照组从105提升至158（+50.5%）

2. 匹配成功率提升
   匹配率从90.8%提升至96.1%
   成功匹配对数从89对增加至122对（+37%）

3. 平衡性未显著改善
   虽然样本量增加，但标准化差异仍然较高
   可能原因：
   a) 试点城市与非试点城市在特征上确实存在较大差异
   b) 当前控制变量（4个）可能不足以充分解释分组
   c) 插值可能引入了测量误差，特别是对整个序列缺失的变量

4. 插值的影响
   • 优点：保留更多样本，提高统计功效
   • 缺点：可能引入噪声，降低匹配精度

七、建议
-----------

1. 增加控制变量
   当前4个控制变量可能不足，建议增加：
   - 财政变量（如财政收入、财政支出）
   - 基础设施（如道路面积、固定资产投资）
   - 开放程度（如外贸依存度）

2. 改进匹配策略
   • 尝试1:k匹配（如1:2或1:3）增加对照组选择
   • 使用核匹配或局部线性回归匹配
   • 考虑Mahalanobis距离匹配

3. 考虑样本选择
   由于试点城市与非试点城市在基期就存在较大差异，
   建议考虑：
   • 使用熵平衡法（Entropy Balancing）
   • 使用合成控制法（Synthetic Control Method）
   • 在DID回归中加入更多控制变量和固定效应

4. 结果解读
   虽然匹配质量未达到理想标准，但：
   • 插值后的样本更具代表性
   • 可以在DID分析中通过控制变量和固定效应进一步调整
   • 需要在论文中充分讨论插值的局限性和稳健性检验

八、后续分析
-----------

使用插值后匹配的数据集进行DID分析：
• 文件: matched_dataset.xlsx (在PSM_Analysis文件夹)
• 样本: 244个城市（122对匹配）
• 时期: 2007-2023年
• DID变量: DID_matched

推荐模型:
Y = β₀ + β₁×DID_matched + β₂×matched_treatment +
    γ×控制变量 + δ×年份FE + θ×城市FE + ε

======================================================================
"""

print(summary)

# 保存报告
with open('PSM_Analysis/imputation_comparison.txt', 'w', encoding='utf-8') as f:
    f.write(summary)

print("\n✓ 对比报告已保存至: PSM_Analysis/imputation_comparison.txt")
