# PSM后DID回归分析

本文件夹包含基于PSM匹配结果进行加权双重差分（DID）回归分析的代码和结果。

## 分析说明

### 分析思路

利用PSM筛选后的匹配样本，进行加权DID回归分析：

1. **权重计算**:
   - 处理组（Treat=1）：每个城市的权重默认为1
   - 控制组（Treat=0）：
     - 未匹配上的城市：权重为0（剔除）
     - 匹配上的城市：权重=它被选中的次数

2. **样本筛选**:
   - 使用PSM匹配后的城市名单
   - 分析期间：2007-2019年全周期

3. **回归模型**:
   - 因变量：ln_emission_intensity_winzorized
   - 核心解释变量：DID（Treat × Post）
   - 控制变量：ln_real_gdp、ln_人口密度、ln_金融发展水平、第二产业占GDP比重
   - 固定效应：城市固定效应 + 年份固定效应
   - 标准误：聚类到城市层面

## 文件说明

### 核心文件

1. **psm_weighted_did.py** - 主分析脚本
   - 读取PSM匹配数据
   - 计算城市权重
   - 进行固定效应回归
   - 生成结果和可视化

### 依赖的文件

- `../PSM-四个变量-2009基期/匹配后数据集_四个变量.xlsx` - PSM匹配结果
- `../总数据集2007-2019_含碳排放强度.xlsx` - 完整数据集

## 使用方法

### 运行分析

```bash
cd PSM后DID分析
py psm_weighted_did.py
```

### 或创建批处理文件

创建 `run_analysis.bat`:
```batch
@echo off
chcp 65001 >nul
echo PSM后DID回归分析
echo.
py psm_weighted_did.py
pause
```

## 输出文件

运行分析后将生成以下文件：

1. **描述性统计.xlsx** - 按处理组和时期的描述性统计
2. **回归结果.txt** - 详细的回归结果文本
3. **回归结果表格.xlsx** - 回归结果表格（含系数、标准误、t值、p值等）
4. **PSM后DID分析可视化.png** - 可视化图表（权重分布、样本分布、趋势图等）
5. **PSM后DID分析报告.txt** - 综合分析报告

## 技术要求

### Python依赖包

```bash
pip install pandas numpy statsmodels linearmodels matplotlib seaborn openpyxl
```

### 主要依赖

- **pandas**: 数据处理
- **numpy**: 数值计算
- **statsmodels**: 统计建模
- **linearmodels**: 面板数据固定效应模型
- **matplotlib/seaborn**: 可视化

## 分析步骤

### 1. 数据准备
- 读取完整数据集（2007-2019）
- 读取PSM匹配后的数据（2009年基期）

### 2. 权重计算
- 统计每个城市在PSM匹配中出现的次数
- 根据处理组/对照组设置权重

### 3. 样本筛选
- 将权重应用到完整数据集
- 剔除权重为0的样本（未匹配上的城市）

### 4. 回归分析
- 使用PanelOLS进行固定效应回归
- 城市固定效应 + 年份固定效应
- 标准误聚类到城市层面

### 5. 结果输出
- 描述性统计
- 回归结果
- 可视化图表

## 模型设定

### 回归方程

```
ln_emission_intensity_winzorized = α + β·DID + γ·Controls + City_FE + Year_FE
```

其中：
- DID = Treat × Post
- Controls = [ln_real_gdp, ln_人口密度, ln_金融发展水平, 第二产业占GDP比重]
- City_FE: 城市固定效应
- Year_FE: 年份固定效应

### 权重设置

- 处理组城市（Treat=1）：权重 = 1
- 对照组城市（Treat=0）：权重 = PSM匹配次数

### 标准误聚类

标准误聚类到城市层面，以处理同一城市不同年份观测值之间的相关性。

## 预期结果

### 回归系数解释

- **DID系数**: 政策效应的净影响
  - 负值且显著：政策显著降低了碳排放强度
  - 正值且显著：政策显著增加了碳排放强度
  - 不显著：政策效果不明显

### 控制变量

控制变量的系数反映各因素对碳排放强度的影响方向和程度。

---

生成时间: 2025-02-12
