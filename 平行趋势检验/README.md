# 平行趋势检验 (Parallel Trend Test)

## 什么是平行趋势假设？

平行趋势假设是双重差分（DID）模型的核心前提条件。

### 定义

在政策实施**之前**，处理组和对照组的因变量变化趋势应该是**平行**的。

### 为什么重要？

只有满足平行趋势假设，DID模型估计的因果关系才有效。如果预处理期趋势不平行，那么政策实施后的差异可能不是政策导致的，而是既有趋势的延续。

## 分析方法

本文件夹使用**事件研究法（Event Study）**进行平行趋势检验。

### 方法原理

1. **动态DID模型**：
   ```
   Y = α + Σ(β_k × Treat × I[rel_year=k]) + Controls + FE
   ```
   - rel_year: 相对于政策实施的年份（2009年=0）
   - β_k: 第k期的处理效应
   - 基准组：通常选政策前一年（rel_year=-1）

2. **检验逻辑**：
   - 如果平行趋势假设成立，所有预处理期系数（k<0）应**不显著异于0**
   - 如果预处理期系数显著，说明两组趋势本来就不平行

3. **可视化**：
   - 绘制各期系数的点估计和置信区间
   - 检查预处理期系数是否围绕0波动

## 文件说明

### 核心文件

1. **parallel_trend_test.py** - 主分析脚本
   - 创建动态DID变量
   - 估计事件研究模型
   - 绘制事件研究图
   - 生成检验报告

### 输出文件

1. **事件研究结果.xlsx** - 各期系数、标准误、t值、p值
2. **平行趋势检验.png** - 四合一可视化图表
3. **平行趋势检验报告.txt** - 详细检验报告

## 使用方法

### 运行分析

```bash
cd 平行趋势检验
py parallel_trend_test.py
```

### 或创建批处理文件

创建 `run_test.bat`:
```batch
@echo off
chcp 65001 >nul
echo 平行趋势检验
echo.
py parallel_trend_test.py
pause
```

## 可视化解读

### 图1：事件研究图（主图）

- **横轴**：相对年份（-2到+10，0为2009年）
- **纵轴**：动态DID系数
- **蓝色点**：各期系数估计值
- **蓝色竖线**：95%置信区间
- **红色虚线**：系数=0参考线
- **绿色虚线**：政策实施线

**判断标准**：
- ✓ **预处理期置信区间包含0**：支持平行趋势
- ✗ **预处理期置信区间不包含0**：违反平行趋势

### 图2：预处理期放大图

专门展示政策实施前的趋势，便于详细检查。

### 图3：原始数据趋势

处理组和对照组的原始数据变化趋势。

### 图4：预处理期趋势可视化

2007-2008年两组的平行程度。

## 检验结果解读

### 结果判断

| 预处理期显著性 | 结论 | DID有效性 |
|--------------|------|----------|
| 所有期均不显著 | ✓ 支持平行趋势假设 | ✓ 有效 |
| 仅1期显著 | △ 基本支持平行趋势 | △ 基本有效 |
| 2期及以上显著 | ✗ 不支持平行趋势 | ✗ 可能有偏 |

### 示例解读

**场景1：支持平行趋势**
```
rel_year = -2: 系数 = 0.0123, p值 = 0.8542
rel_year = -1: 基准组
```
→ 所有预处理期p值>0.1，不显著 → **满足平行趋势假设** → DID估计**可信**

**场景2：违反平行趋势**
```
rel_year = -2: 系数 = 0.1567, p值 = 0.0234 **
rel_year = -1: 基准组
```
→ 预处理期系数显著 → **不满足平行趋势假设** → DID估计**可能有偏**

## 如违反平行趋势怎么办？

### 选项1：调整样本
- 缩短研究窗口
- 剔除极端值
- 重新进行PSM匹配

### 选项2：增加控制变量
- 加入更多协变量
- 使用时变控制变量

### 选项3：使用其他方法
- 合成控制法（Synthetic Control Method）
- 匹配双重差分（PSM-DID）
- 趋向得分匹配（TSM）

### 选项4：检验动态效应
- 检查政策效应的演变模式
- 可能存在滞后效应或预期效应

## 技术细节

### 模型设定

```
ln(排放强度) = α + Σ(β_k × Treat × I[year-2009=k])
               + γ₁×ln(GDP) + γ₂×ln(人口密度)
               + γ₃×ln(金融发展) + γ₄×产业结构
               + City_FE + Year_FE
```

### 固定效应
- **EntityEffects**（城市固定效应）：控制城市间不随时间变化的差异
- **TimeEffects**（年份固定效应）：控制时间趋势和共同冲击

### 标准误
- 聚类到城市层面（Clustered by city）
- 允许同一城市不同年份数据的相关性

## 依赖包

```bash
pip install pandas numpy statsmodels linearmodels matplotlib seaborn openpyxl
```

## 参考文献

1. **Jacobson, LaLonde, and Sullivan (1993)**: 事件研究法在劳动力市场的应用
2. **Autor (2003)**: 平行趋势检验的经典应用
3. **Athey and Imbens (2006)**: 因果推断中的识别策略

---

常见问题：

**Q: 为什么选2008年（rel_year=-1）作为基准组？**
A: 通常选政策前一年作为基准，避免政策预期效应的影响。

**Q: 预处理期只有1-2年够吗？**
A: 理论需要至少3期，但实际研究常受数据限制。期数越多，检验越可靠。

**Q: 如果预处理期部分显著怎么办？**
A: 考察显著程度和模式，结合经济意义判断。如有疑问，尝试稳健性检验。

生成时间: 2025-02-12
